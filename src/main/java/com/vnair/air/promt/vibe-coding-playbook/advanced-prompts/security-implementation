Security Implementation Template — VNair

Mục tiêu: Thiết kế và triển khai tính năng bảo mật một cách ưu tiên an toàn, có threat model và kiểm chứng.

Ngữ cảnh hệ thống tóm tắt: Spring Boot 3.5.4, Spring Security, JWT+refresh, Postgres, Payment integrations; PCI awareness

Yêu cầu bảo mật cần triển khai: [ví dụ: token rotation, webhook signature verification, RBAC fine-grained, rate limit, secrets management]

1) Threat model
- Mối đe doạ nhắm vào yêu cầu này: [liệt kê]
- Vectors chưa xử lý: [liệt kê]
- Tác động nếu thất bại: [business/technical]
- Giả định: [https everywhere, secure storage…]

2) Thiết kế bảo mật
- Defense-in-depth: [network, app, data]
- AuthN/AuthZ: [JWT rotation/short-lived, refresh, RBAC]
- Bảo vệ dữ liệu: at-rest (PG encryption options), in-transit (TLS), in-use (masking/logging)
- Key/Secret management: [keystore/.env vault, rotation schedule]
- Session/timeout: [access 15m, refresh 7d, revoke]
- Validation/Encoding: [Bean Validation, output encoding]

3) Triển khai
- Thư viện: [Spring Security, jjwt/nimbus, Resilience4j]
- Cấu hình: yml theo profiles; deny-by-default
- Secrets: không hardcode; dùng env/secret store
- Certificates: renew automation (Let’s Encrypt) nếu web
- DB security: least privilege user, parameterized queries
- Network: firewall rules, rate limiting/basic WAF

4) Xác thực/đánh giá
- Unit/integration tests cho flows quan trọng
- Security scanning: SAST/Dependency check
- Pentest/light review checklist
- Compliance checklist: logs, audit, retention

5) Vận hành
- Logging/monitoring: auth failures, token misuse, webhook signature fails
- IR runbook: bước cô lập, thu thập bằng chứng, rollback
- Metrics/alerts: spikes, anomalies
- Backup/DR: khoá/secret backup an toàn; test restore

6) Rollout
- Canary/feature flag; rollback nhanh
- Giao tiếp người dùng (nếu thay đổi UX)
- Verify post-deploy: scripted checks + dashboards

Output yêu cầu (AI phải xuất đúng định dạng):
```yaml
security_plan:
  requirement: "webhook_signature_verification"
  threats: ["replay","tampering"]
  design:
    signing: "HMAC-SHA256"
    clock_skew_sec: 300
  implementation:
    libs: ["Spring Security"]
    storage: "secret store"
  validation: ["unit tests","replay test"]
  rollout: ["feature-flag","canary"]
```
